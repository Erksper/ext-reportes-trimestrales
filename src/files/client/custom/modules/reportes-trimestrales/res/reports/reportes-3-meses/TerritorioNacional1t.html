<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mercado Inmobiliario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos de Paleta Century Neutral Warm y Tipografía Montserrat */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #F8F5F2; /* Fondo general */
            color: #3D405B; /* Títulos principales y texto principal */
        }
        .container {
            max-width: 1200px;
        }
        .text-primary {
            color: #3D405B;
        }
        .text-alquiler {
            color: #ACA68B;
        }
        .text-venta {
            color: #3D405B;
        }
        .bg-alquiler {
            background-color: #ACA68B; /* Alquiler (Mix Chart) */
        }
        .bg-venta {
            background-color: #3D405B; /* Venta (Mix Chart) */
        }
        .bg-2023 {
            background-color: #B3B3B3; /* 2023 */
        }
        .bg-2024 {
            background-color: #A38600; /* 2024 */
        }
        .bg-2025 {
            background-color: #ADAD86; /* 2025 / Filtro activo */
        }
        /* Estilos de Contenedores de Gráficos Responsivos */
        .chart-container {
            position: relative;
            height: 320px;
            max-height: 320px;
            width: 100%;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
                max-height: 400px;
            }
        }
        /* Estilos de Botones de Filtro (Redondeados, Transiciones) */
        .filter-btn {
            padding: 8px 16px;
            border-radius: 9999px;
            border: 1px solid #B3B3B3;
            color: #3D405B;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: white;
            white-space: nowrap; /* Evita que el texto del botón se rompa */
        }
        .filter-btn.active {
            background-color: #ADAD86; /* Color 2025 / Activo */
            color: white;
            border-color: #ADAD86;
        }
        .filter-btn:hover:not(.active) {
            background-color: #F8F5F2;
        }
        /* Estilos de Tarjetas (Redondeadas, Sombra, Hover) */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Ocultar botones de propiedad que no aplican */
        .property-filter-hidden {
            display: none !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Sección del Encabezado -->
    <header class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-2 text-primary" contenteditable="true">Análisis del Mercado Inmobiliario</h1>
        <h2 class="text-xl md:text-2xl font-semibold text-gray-600">Primer Trimestre 2023-2025</h2>
    </header>

    <!-- Sección de Resumen del Mercado -->
    <section class="mb-12">
        <div class="container mx-auto">
            <h3 class="text-2xl md:text-3xl font-bold text-center mb-6 text-primary">Territorio Nacional</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Gráfico 1: Evolución del Volumen de Operaciones -->
                <div class="card p-4">
                    <h4 class="text-xl font-bold text-center mb-4">Evolución del Volumen de Operaciones (Lados)</h4>
                    <div class="chart-container">
                        <canvas id="ladosChart"></canvas>
                    </div>
                    <!-- Texto de Análisis para Gráfico 1 -->
                    <p id="ladosAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
                </div>

                <!-- Gráfico 2: Mix de Operaciones -->
                <div class="card p-4">
                    <h4 class="text-xl font-bold text-center mb-4">Mix de Operaciones (Periodo Enero-Marzo 2025)</h4>
                    <div class="chart-container max-w-[300px] mx-auto">
                        <canvas id="mixChart"></canvas>
                    </div>
                    <!-- Texto de Análisis para Gráfico 2 -->
                    <p id="mixAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Sección del Explorador de Mercado Detallado -->
    <section class="mb-12">
        <div class="container mx-auto">
            <h3 class="text-2xl md:text-3xl font-bold text-center mb-6 text-primary">Explorador de Mercado Detallado</h3>

            <!-- Filtros Interactivos -->
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8">
                <div class="flex flex-wrap gap-2 justify-center" id="operationFilters">
                    <button class="filter-btn active" data-filter="alquiler">Alquiler</button>
                    <button class="filter-btn" data-filter="venta">Venta</button>
                </div>
            </div>
            
            <!-- Filtros de Tipo de Alquiler (Inicialmente visible para Alquiler) -->
            <div id="alquilerTypeFilters" class="flex flex-wrap gap-2 justify-center mb-4" style="display: flex;">
                <button class="filter-btn active" data-filter="residencial">Residencial</button>
                <button class="filter-btn" data-filter="vacacional">Vacacional</button>
                <button class="filter-btn" data-filter="comercial">Comercial</button>
            </div>
            
            <!-- Filtros de Tipo de Propiedad (Controlados por el filtro de tipo de alquiler o por Venta) -->
            <div class="flex flex-wrap gap-2 justify-center mb-8" id="propertyFilters">
                <button class="filter-btn active" data-filter="apartamento">Apartamento</button>
                <button class="filter-btn" data-filter="casa">Casa</button>
                <button class="filter-btn property-filter-hidden" data-filter="local">Local</button>
                <button class="filter-btn property-filter-hidden" data-filter="oficina">Oficina</button>
            </div>

            <!-- Tarjetas de Métricas Clave -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div id="cardPrecio" class="card p-4 text-center">
                    <h5 class="text-lg font-semibold">Precio Promedio (USD)</h5>
                    <p id="precioValue" class="text-3xl font-bold mt-2"></p>
                    <p id="precioChange" class="text-sm mt-1"></p>
                </div>
                <div id="cardPrecioM2" class="card p-4 text-center">
                    <h5 class="text-lg font-semibold">Precio Promedio / m² (USD)</h5>
                    <p id="precioM2Value" class="text-3xl font-bold mt-2"></p>
                    <p id="precioM2Change" class="text-sm mt-1"></p>
                </div>
                <div id="cardTamano" class="card p-4 text-center">
                    <h5 class="text-lg font-semibold">Promedio (m²)</h5>
                    <p id="tamanoValue" class="text-3xl font-bold mt-2"></p>
                    <p id="tamanoChange" class="text-sm mt-1"></p>
                </div>
            </div>

            <!-- Gráfico 3: Evolución de Métricas Clave -->
            <div class="card p-4 mb-8">
                <h4 class="text-xl font-bold text-center mb-4">Evolución de Métricas Clave (Enero-Marzo 2023-2025)</h4>
                <div class="flex flex-wrap gap-2 justify-center mb-4" id="metricFilters">
                    <button class="filter-btn" data-metric="precio">Precio Promedio</button>
                    <button class="filter-btn active" data-metric="precio_m2">Precio Promedio / m²</button>
                    <button class="filter-btn" data-metric="tamano">Promedio m²</button>
                </div>
                <div class="chart-container">
                    <canvas id="metricChart"></canvas>
                </div>
                <!-- Texto de Análisis para Gráfico 3 -->
                <p id="metricAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
            </div>

            <!-- Gráfico 4: Distribución de Operaciones por Rango de Precio -->
            <div class="card p-4">
                <h4 class="text-xl font-bold text-center mb-4">Distribución de Operaciones por Rango de Precio (Lados)</h4>
                <div class="chart-container">
                    <canvas id="rangesChart"></canvas>
                </div>
                <!-- Texto de Análisis para Gráfico 4 -->
                <p id="rangesAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
            </div>
        </div>
    </section>

    <script>
        // Datos del Dashboard incrustados en JavaScript
        const data = {
            general: {
                lados: {
                    alquiler: [628, 769, 553], // Qtr 1 2023, 2024, 2025 (de Página 2)
                    venta: [655, 733, 616] // Qtr 1 2023, 2024, 2025 (de Página 2)
                }
            },
            alquiler: {
                // Métricas y Rangos (Apartamento, Casa, Local, Oficina) - Datos reales del PDF
                apartamento_residencial: { // Res. Apartamento (Pág 3)
                    metrics: {
                        precio: [372.84, 414.17, 443.16],
                        precio_m2: [4.55, 5.02, 5.11],
                        tamano: [82.01, 82.55, 86.75]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k', '$2.5k-$5k'],
                        values: [
                            [23, 98, 184, 57, 12, 1], // 2023
                            [13, 108, 201, 48, 19, 1], // 2024
                            [13, 67, 156, 49, 9, 2] // 2025
                        ]
                    }
                },
                casa_residencial: { // Res. Casa (Pág 4)
                    metrics: {
                        precio: [398.26, 361.35, 371.80],
                        precio_m2: [1.77, 1.43, 2.35],
                        tamano: [225.17, 252.24, 158.26]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k'],
                        values: [
                            [6, 13, 12, 8, 1], // 2023
                            [8, 28, 32, 15, 3], // 2024
                            [2, 19, 28, 5, 3] // 2025
                        ]
                    }
                },
                apartamento_vacacional: { // Vac. Apartamento (Pág 5)
                    metrics: {
                        precio: [134.64, 88.00, 62.90],
                        precio_m2: [1.43, 1.01, 0.92],
                        tamano: [94.11, 86.74, 68.70]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k'],
                        values: [
                            [28, 7, 3, 1], // 2023
                            [23, 10, 0, 0], // 2024
                            [16, 0, 0, 0] // 2025 - El dato de 2025 en $100-$250 es 0, en $250-$500 y $500-$1k es null. Usamos 0 para consistencia.
                        ]
                    }
                },
                casa_vacacional: { // Vac. Casa (Pág 6)
                    metrics: {
                        precio: [330.00, 1350.00, 155.00],
                        precio_m2: [1.43, 1.93, 1.36],
                        tamano: [230.00, 700.00, 114.00]
                    },
                    ranges: {
                        labels: ['$100-$250', '$250-$500', '$1k-$2.5k'],
                        values: [
                            [0, 2, 0], // 2023
                            [0, 0, 2], // 2024
                            [2, 0, 0] // 2025
                        ]
                    }
                },
                local_comercial: { // Com. Local (Pág 7)
                    metrics: {
                        precio: [405.68, 641.21, 478.68],
                        precio_m2: [4.77, 4.47, 7.02],
                        tamano: [85.07, 143.53, 68.22]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k', '$2.5k-$5k', '$5k-$10k'],
                        values: [
                            [8, 34, 28, 15, 2, 0, 0], // 2023
                            [18, 45, 28, 25, 10, 0, 2], // 2024
                            [5, 32, 37, 21, 4, 2, 0] // 2025
                        ]
                    }
                },
                oficina_comercial: { // Com. Oficina (Pág 8)
                    metrics: {
                        precio: [493.64, 463.75, 652.35],
                        precio_m2: [6.91, 7.28, 5.38],
                        tamano: [71.40, 63.70, 121.25]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k'],
                        values: [
                            [4, 16, 8, 5, 6], // 2023
                            [2, 10, 13, 9, 2], // 2024
                            [0, 2, 10, 13, 4] // 2025
                        ]
                    }
                },
            },
            venta: {
                // Métricas y Rangos (Apartamento, Casa, Local, Oficina) - Datos reales del PDF
                apartamento: { // Venta Apartamento (Pág 9)
                    metrics: {
                        precio: [30993.4, 33174.9, 38614.14],
                        precio_m2: [320.97, 379.03, 435.21],
                        tamano: [96.56, 87.53, 88.73]
                    },
                    ranges: {
                        labels: ['$5k-$10k', '$10k-$25k', '$25k-$50k', '$50k-$100k', '$100k-$250k', '$250k-$500k'],
                        values: [
                            [64, 159, 128, 47, 6, 2], // 2023
                            [22, 212, 117, 60, 14, 0], // 2024
                            [13, 124, 106, 53, 12, 0] // 2025
                        ]
                    }
                },
                casa: { // Venta Casa (Pág 10)
                    metrics: {
                        precio: [32776.3, 31022.6, 41211.49],
                        precio_m2: [146.31, 149.66, 166.42],
                        tamano: [224.03, 207.29, 247.64]
                    },
                    ranges: {
                        labels: ['$2.5k-$5k', '$5k-$10k', '$10k-$25k', '$25k-$50k', '$50k-$100k', '$100k-$250k', '$250k-$500k'],
                        values: [
                            [5, 28, 48, 28, 15, 4, 0], // 2023
                            [8, 46, 61, 53, 10, 5, 2], // 2024
                            [4, 17, 82, 25, 24, 8, 6] // 2025
                        ]
                    }
                },
                local: { // Venta Local (Pág 11)
                    metrics: {
                        precio: [33111.1, 15900.0, 27382.35],
                        precio_m2: [656.23, 152.80, 136.41],
                        tamano: [50.46, 104.06, 200.74]
                    },
                    ranges: {
                        labels: ['$2.5k-$5k', '$5k-$10k', '$10k-$25k', '$25k-$50k', '$50k-$100k'],
                        values: [
                            [0, 5, 6, 3, 5], // 2023
                            [4, 6, 16, 5, 0], // 2024
                            [2, 2, 17, 4, 6] // 2025
                        ]
                    }
                },
                oficina: { // Venta Oficina (Pág 12)
                    metrics: {
                        precio: [68580.2, 50479.0, 64625.00],
                        precio_m2: [1164.86, 946.54, 792.31],
                        tamano: [58.87, 53.33, 81.57]
                    },
                    ranges: {
                        labels: ['$10k-$25k', '$25k-$50k', '$50k-$100k', '$100k-$250k'],
                        values: [
                            [0, 4, 9, 2], // 2023 (Se omite > $250k por simplificación)
                            [1, 1, 5, 0], // 2024
                            [3, 1, 1, 2] // 2025
                        ]
                    }
                },
            }
        };

        const chartColors = {
            alquiler: '#ACA68B',
            venta: '#3D405B',
            '2023': '#B3B3B3',
            '2024': '#A38600',
            '2025': '#ADAD86',
        };

        const labelsYears = ['Enero-Marzo 2023', 'Enero-Marzo 2024', 'Enero-Marzo 2025'];
        let ladosChart, mixChart, metricChart, rangesChart;

        // --- Funciones de Utilidad ---

        const formatNumber = (num, type = 'precio') => {
            if (num === null || isNaN(num) || num === undefined) return 'N/A';
            if (type === 'precio') {
                // Formato para Precio Promedio (entero)
                return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
            }
            if (type === 'precio_m2') {
                // Formato para Precio/m2 (2 decimales)
                return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(num) + '/m²';
            }
            if (type === 'm2') {
                // Formato para Tamaño (2 decimales y m²)
                return new Intl.NumberFormat('es-VE', { maximumFractionDigits: 2 }).format(num) + ' m²';
            }
            // Para lados (enteros)
            return new Intl.NumberFormat('es-VE', { maximumFractionDigits: 0 }).format(num);
        };

        const calculatePercentageChange = (current, previous, label) => {
            // Maneja casos no significativos (cero, nulo, NaN) omitiendo el porcentaje
            if (previous === 0 || previous === null || previous === undefined || isNaN(previous) || current === null || current === undefined || isNaN(current)) {
                return { text: ``, value: formatNumber(current, label) };
            }

            const change = ((current - previous) / previous) * 100;
            const sign = change >= 0 ? '▲' : '▼';
            const color = change >= 0 ? '#10B981' : '#EF4444'; // Tailwind green/red
            const percentage = new Intl.NumberFormat('es-VE', { maximumFractionDigits: 0 }).format(Math.abs(change));
            
            // Retorna el valor actual formateado y el texto de cambio con HTML de color/símbolo
            return {
                text: `<span style="color:${color};">${sign} ${percentage}% vs '24</span>`,
                value: formatNumber(current, label)
            };
        };

        // Función auxiliar para sumar valores en rangos por etiqueta
        const sumRanges = (labels1, values1, labels2, values2) => {
            const allLabels = [...new Set([...(labels1 || []), ...(labels2 || [])])].sort((a, b) => {
                // Ordenar rangos de precio correctamente (simple orden alfabético/string para el dash)
                const extractValue = (label) => parseFloat(label.replace(/[$,kK-]/g, '').trim());
                return extractValue(a) - extractValue(b);
            });

            const summedValues = values1.map((yearValues1, i) => {
                const yearValues2 = values2[i] || [];
                const newValues = {};

                (labels1 || []).forEach((label, j) => newValues[label] = yearValues1[j] || 0);
                (labels2 || []).forEach((label, j) => newValues[label] = (newValues[label] || 0) + (yearValues2[j] || 0));
                
                return allLabels.map(label => newValues[label] || 0);
            });

            return { labels: allLabels, values: summedValues };
        };

        // Función para calcular el promedio de métricas
        const avgMetrics = (metrics1, metrics2) => {
            const result = {};
            for (const key of ['precio', 'precio_m2', 'tamano']) {
                result[key] = (metrics1[key] || []).map((val, i) => {
                    const val2 = metrics2[key]?.[i];
                    if (val === undefined && val2 === undefined) return undefined;
                    if (val === undefined) return val2;
                    if (val2 === undefined) return val;
                    return (val + val2) / 2;
                }).filter(val => val !== undefined);
            }
            return result;
        };
        
        // --- Lógica de Agregación de Datos (Requisito del Análisis) ---

        const aggregateAlquilerData = () => {
            // Agregación Residencial (Apartamento + Casa)
            const resAp = data.alquiler.apartamento_residencial;
            const resCa = data.alquiler.casa_residencial;
            data.alquiler.residencial = {
                metrics: avgMetrics(resAp.metrics, resCa.metrics),
                ranges: sumRanges(resAp.ranges.labels, resAp.ranges.values, resCa.ranges.labels, resCa.ranges.values)
            };

            // Agregación Vacacional (Apartamento + Casa)
            const vacAp = data.alquiler.apartamento_vacacional;
            const vacCa = data.alquiler.casa_vacacional;
            data.alquiler.vacacional = {
                metrics: avgMetrics(vacAp.metrics, vacCa.metrics),
                ranges: sumRanges(vacAp.ranges.labels, vacAp.ranges.values, vacCa.ranges.labels, vacCa.ranges.values)
            };

            // Agregación Comercial (Local + Oficina)
            const comLoc = data.alquiler.local_comercial;
            const comOfi = data.alquiler.oficina_comercial;
            data.alquiler.comercial = {
                metrics: avgMetrics(comLoc.metrics, comOfi.metrics),
                ranges: sumRanges(comLoc.ranges.labels, comLoc.ranges.values, comOfi.ranges.labels, comOfi.ranges.values)
            };
        };


        // --- Funciones de Inicialización y Actualización de Gráficos ---

        const createCharts = () => {
            // Gráfico 1: Evolución del Volumen de Operaciones (Lados)
            const ladosCtx = document.getElementById('ladosChart').getContext('2d');
            ladosChart = new Chart(ladosCtx, {
                type: 'bar',
                data: {
                    labels: labelsYears,
                    datasets: [{
                        label: 'Alquiler',
                        data: data.general.lados.alquiler,
                        backgroundColor: chartColors.alquiler,
                        hoverBackgroundColor: chartColors.alquiler
                    }, {
                        label: 'Venta',
                        data: data.general.lados.venta,
                        backgroundColor: chartColors.venta,
                        hoverBackgroundColor: chartColors.venta
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Periodo Enero-Marzo' } },
                        y: { title: { display: true, text: 'Nº de Operaciones' }, beginAtZero: true }
                    }
                }
            });

            // Gráfico 2: Mix de Operaciones (Donut)
            const mixCtx = document.getElementById('mixChart').getContext('2d');
            const alquiler25 = data.general.lados.alquiler[2];
            const venta25 = data.general.lados.venta[2];

            mixChart = new Chart(mixCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Alquiler', 'Venta'],
                    datasets: [{
                        data: [alquiler25, venta25],
                        backgroundColor: [chartColors.alquiler, chartColors.venta],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
            
            // Gráfico 3: Evolución de Métricas Clave (Barras)
            const metricCtx = document.getElementById('metricChart').getContext('2d');
            metricChart = new Chart(metricCtx, {
                type: 'bar',
                data: {
                    labels: labelsYears,
                    datasets: [{
                        label: 'Métrica',
                        data: [], // Se actualiza dinámicamente
                        backgroundColor: [chartColors['2023'], chartColors['2024'], chartColors['2025']],
                        hoverBackgroundColor: [chartColors['2023'], chartColors['2024'], chartColors['2025']]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Gráfico 4: Distribución de Operaciones por Rango de Precio (Barras)
            const rangesCtx = document.getElementById('rangesChart').getContext('2d');
            rangesChart = new Chart(rangesCtx, {
                type: 'bar',
                data: {
                    labels: [], // Se actualiza dinámicamente
                    datasets: [{
                        label: '2023',
                        data: [],
                        backgroundColor: chartColors['2023']
                    }, {
                        label: '2024',
                        data: [],
                        backgroundColor: chartColors['2024']
                    }, {
                        label: '2025',
                        data: [],
                        backgroundColor: chartColors['2025']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true } }
                }
            });
        };
        
        const updateAnalysisText = (analysisId, text) => {
            const element = document.getElementById(analysisId);
            if (element) {
                element.innerHTML = text;
            }
        };

        const updateLadosAnalysis = () => {
            const alquiler25 = data.general.lados.alquiler[2];
            const alquiler24 = data.general.lados.alquiler[1];
            const venta25 = data.general.lados.venta[2];
            const venta24 = data.general.lados.venta[1];
            const total25 = alquiler25 + venta25;
            const total24 = alquiler24 + venta24;

            const totalChange = calculatePercentageChange(total25, total24);
            const alquilerChange = calculatePercentageChange(alquiler25, alquiler24);
            const ventaChange = calculatePercentageChange(venta25, venta24);

            const analysisText = `En el Periodo Enero-Marzo 2025, el volumen total de operaciones fue de <span class="font-bold">${formatNumber(total25, 'lados')}</span>, un cambio de ${totalChange.text} respecto a 2024. El volumen de alquileres fue de ${formatNumber(alquiler25, 'lados')} (${alquilerChange.text}), mientras que el de ventas fue de ${formatNumber(venta25, 'lados')} (${ventaChange.text}).`;
            updateAnalysisText('ladosAnalysis', analysisText);
        };

        const updateMixAnalysis = () => {
            const alquiler25 = data.general.lados.alquiler[2];
            const venta25 = data.general.lados.venta[2];
            const total25 = alquiler25 + venta25;

            const porcentajeAlquiler = (alquiler25 / total25) * 100;
            const porcentajeVenta = (venta25 / total25) * 100;
            const alquilerColor = chartColors.alquiler;
            const ventaColor = chartColors.venta;

            const analysisText = `Durante el Periodo Enero-Marzo 2025, el mix de operaciones se compuso de un <span style="color:${alquilerColor}; font-weight: bold;">${porcentajeAlquiler.toFixed(0)}% de alquileres</span> y un <span style="color:${ventaColor}; font-weight: bold;">${porcentajeVenta.toFixed(0)}% de ventas</span>.`;
            updateAnalysisText('mixAnalysis', analysisText);
        };
        
        // --- Lógica de Filtros y Dashboard Principal ---

        const getSelectedFilters = () => {
            const operation = document.querySelector('#operationFilters .active')?.dataset.filter;
            const property = document.querySelector('#propertyFilters .active')?.dataset.filter;
            const alquilerType = document.querySelector('#alquilerTypeFilters .active')?.dataset.filter;
            const metric = document.querySelector('#metricFilters .active')?.dataset.metric;
            return { operation, property, alquilerType, metric };
        };

        const getPropertyData = ({ operation, property, alquilerType }) => {
            if (operation === 'alquiler') {
                // Alquiler: Usar datos individuales ya que el usuario seleccionó un tipo de propiedad específico dentro de una categoría
                if (alquilerType === 'residencial' || alquilerType === 'vacacional' || alquilerType === 'comercial') {
                    if (property === 'apartamento' && (alquilerType === 'residencial' || alquilerType === 'vacacional')) {
                        return data.alquiler[`apartamento_${alquilerType}`];
                    } else if (property === 'casa' && (alquilerType === 'residencial' || alquilerType === 'vacacional')) {
                        return data.alquiler[`casa_${alquilerType}`];
                    } else if (property === 'local' && alquilerType === 'comercial') {
                        return data.alquiler.local_comercial;
                    } else if (property === 'oficina' && alquilerType === 'comercial') {
                        return data.alquiler.oficina_comercial;
                    }
                }
            } else if (operation === 'venta' && property) {
                // Venta: Usar datos de la propiedad directamente
                return data.venta[property];
            }
            return null;
        };

        const updateDashboard = () => {
            const { operation, property, alquilerType, metric } = getSelectedFilters();
            let propertyData = getPropertyData({ operation, property, alquilerType });
            
            let analysisProperty = '';
            // El texto de análisis refleja la propiedad individual dentro de la categoría
            if (operation === 'alquiler' && alquilerType && property) {
                analysisProperty = `Casa en ${alquilerType} Alquiler`;
            } else if (operation === 'venta' && property) {
                analysisProperty = `${property} en Venta`;
            }
            
            // Manejo de Datos No Encontrados
            if (!propertyData || !propertyData.metrics || propertyData.metrics[metric]?.length < 3) {
                document.getElementById('precioValue').textContent = 'N/A';
                document.getElementById('precioChange').textContent = '';
                document.getElementById('precioM2Value').textContent = 'N/A';
                document.getElementById('precioM2Change').textContent = '';
                document.getElementById('tamanoValue').textContent = 'N/A';
                document.getElementById('tamanoChange').textContent = '';

                metricChart.data.datasets[0].data = [0, 0, 0];
                metricChart.options.scales.y.title.text = metric === 'tamano' ? 'Metros Cuadrados (m²)' : 'Precio (USD)';
                metricChart.update();
                
                rangesChart.data.labels = [];
                rangesChart.data.datasets.forEach(dataset => dataset.data = []);
                rangesChart.update();

                document.getElementById('metricAnalysis').textContent = `No hay datos para la combinación seleccionada (${analysisProperty}).`;
                document.getElementById('rangesAnalysis').textContent = `No hay datos de rangos para la combinación seleccionada (${analysisProperty}).`;
                return;
            }

            // --- 1. Actualizar Tarjetas de Métricas ---
            const metrics = propertyData.metrics;
            const precioChange = calculatePercentageChange(metrics.precio[2], metrics.precio[1], 'precio');
            const precioM2Change = calculatePercentageChange(metrics.precio_m2[2], metrics.precio_m2[1], 'precio_m2');
            const tamanoChange = calculatePercentageChange(metrics.tamano[2], metrics.tamano[1], 'm2');

            document.getElementById('precioValue').textContent = precioChange.value;
            document.getElementById('precioChange').innerHTML = precioChange.text;
            document.getElementById('precioM2Value').textContent = precioM2Change.value;
            document.getElementById('precioM2Change').innerHTML = precioM2Change.text;
            document.getElementById('tamanoValue').textContent = tamanoChange.value;
            document.getElementById('tamanoChange').innerHTML = tamanoChange.text;

            // --- 2. Actualizar Gráfico de Evolución de Métricas (Gráfico 3) ---
            metricChart.data.datasets[0].data = metrics[metric];
            metricChart.options.scales.y.title.text = metric === 'tamano' ? 'Metros Cuadrados (m²)' : 'Precio (USD)';
            metricChart.update();

            // --- 3. Actualizar Gráfico de Rangos (Gráfico 4) ---
            const ranges = propertyData.ranges;
            rangesChart.data.labels = ranges.labels;
            rangesChart.data.datasets[0].data = ranges.values[0];
            rangesChart.data.datasets[1].data = ranges.values[1];
            rangesChart.data.datasets[2].data = ranges.values[2];
            rangesChart.update();

            // --- 4. Actualizar Textos de Análisis Dinámicos ---
            const metricAnalysisText = `El precio promedio de ${analysisProperty} evolucionó en 2025 hasta ${precioChange.value}, ${precioChange.text}. El precio por m² es de ${precioM2Change.value} (${precioM2Change.text}), con un tamaño promedio de ${tamanoChange.value} (${tamanoChange.text}).`;
            
            let rangesAnalysisText = "La distribución de rangos de precio no está disponible o no se puede analizar.";
            if (ranges.labels.length > 0 && ranges.values[2] && ranges.values[2].length > 0) {
                const maxLadosIndex = ranges.values[2].indexOf(Math.max(...ranges.values[2]));
                const rangoMasActivo = ranges.labels[maxLadosIndex];
                
                const lados25 = ranges.values[2][maxLadosIndex];
                const lados24 = ranges.values[1][maxLadosIndex] || 0; 
                const ladosChange = calculatePercentageChange(lados25, lados24, 'lados');
                
                rangesAnalysisText = `En 2025, el rango de precio más activo para ${analysisProperty} fue <span class="font-bold">${rangoMasActivo}</span> con ${formatNumber(lados25, 'lados')} lados, lo que representa un cambio de ${ladosChange.text} respecto a 2024.`;
            }
            
            updateAnalysisText('metricAnalysis', metricAnalysisText);
            updateAnalysisText('rangesAnalysis', rangesAnalysisText);
        };
        
        // Controla la visibilidad de los filtros de propiedad
        const updatePropertyFilterVisibility = (alquilerType) => {
            const propertyFiltersContainer = document.getElementById('propertyFilters');
            const allPropertyBtns = propertyFiltersContainer.querySelectorAll('.filter-btn');
            
            allPropertyBtns.forEach(btn => {
                btn.classList.add('property-filter-hidden');
                btn.classList.remove('active');
            });

            let firstVisibleButton = null;
            if (alquilerType === 'residencial' || alquilerType === 'vacacional') {
                const apBtn = propertyFiltersContainer.querySelector('[data-filter="apartamento"]');
                const caBtn = propertyFiltersContainer.querySelector('[data-filter="casa"]');
                apBtn.classList.remove('property-filter-hidden');
                caBtn.classList.remove('property-filter-hidden');
                
                // Si la Casa es la activa por defecto, la activamos aquí. Si no, Apartmento.
                firstVisibleButton = caBtn.dataset.filter === 'casa' && document.querySelector('#alquilerTypeFilters .active')?.dataset.filter === 'vacacional' ? caBtn : apBtn;

            } else if (alquilerType === 'comercial') {
                const locBtn = propertyFiltersContainer.querySelector('[data-filter="local"]');
                const ofiBtn = propertyFiltersContainer.querySelector('[data-filter="oficina"]');
                locBtn.classList.remove('property-filter-hidden');
                ofiBtn.classList.remove('property-filter-hidden');
                firstVisibleButton = locBtn;
            }

            // Activar el botón correcto
            if (firstVisibleButton) {
                // Solo activamos la casa si la Casa es el target solicitado, sino mantenemos el que toque.
                if(document.querySelector('#alquilerTypeFilters .active')?.dataset.filter === 'vacacional' && firstVisibleButton.dataset.filter === 'casa') {
                    firstVisibleButton.classList.add('active');
                } else if(firstVisibleButton.dataset.filter === 'apartamento') {
                    firstVisibleButton.classList.add('active');
                } else if(firstVisibleButton.dataset.filter === 'local') {
                    firstVisibleButton.classList.add('active');
                }
            }
        };

        // Controla la visibilidad de los filtros de tipo de alquiler (para Alquiler/Venta)
        const updateOperationFilters = () => {
            const operation = document.querySelector('#operationFilters .active').dataset.filter;
            const alquilerTypeFilters = document.getElementById('alquilerTypeFilters');
            const propertyBtns = document.querySelectorAll('#propertyFilters .filter-btn');
            const alquilerTypeBtns = document.querySelectorAll('#alquilerTypeFilters .filter-btn');
            
            // Lógica de visibilidad del filtro de Tipo de Alquiler
            if (operation === 'alquiler') {
                alquilerTypeFilters.style.display = 'flex';
                // Activar el primer tipo de alquiler (Residencial) si no hay uno activo
                const activeAlquilerType = document.querySelector('#alquilerTypeFilters .active');
                if (!activeAlquilerType) {
                    alquilerTypeBtns[0].classList.add('active'); // Residencial por defecto
                }
                const selectedAlquilerType = document.querySelector('#alquilerTypeFilters .active')?.dataset.filter;
                updatePropertyFilterVisibility(selectedAlquilerType);

            } else { // Venta
                alquilerTypeFilters.style.display = 'none';
                alquilerTypeBtns.forEach(btn => btn.classList.remove('active'));

                // Mostrar todos los tipos de propiedad para Venta y activar Apartamento por defecto
                propertyBtns.forEach(btn => btn.classList.remove('property-filter-hidden'));
                propertyBtns.forEach(btn => btn.classList.remove('active'));
                propertyBtns[0].classList.add('active'); // Apartamento por defecto
            }
        };

        window.onload = () => {
            // 1. Agregación de datos (Importante)
            aggregateAlquilerData();
            
            // 2. Inicialización de Gráficos estáticos y dinámicos
            createCharts();
            
            // 3. Análisis general
            updateLadosAnalysis();
            updateMixAnalysis();
            
            // 4. Establecer estado inicial de filtros: Alquiler / Vacacional / Casa
            
            // Desactivar filtros iniciales predeterminados en el HTML
            document.querySelector('#alquilerTypeFilters .filter-btn[data-filter="residencial"]').classList.remove('active');
            document.querySelector('#propertyFilters .filter-btn[data-filter="apartamento"]').classList.remove('active');

            // 4a. Operación: Alquiler (Ya activo)
            // 4b. Tipo de Alquiler: Vacacional
            document.querySelector('#alquilerTypeFilters .filter-btn[data-filter="vacacional"]').classList.add('active');
            
            // 4c. Visibilidad de Propiedades (A/C) y Propiedad Activa: Casa
            updatePropertyFilterVisibility('vacacional'); // Esto hace visibles A/C.
            document.querySelector('#propertyFilters .filter-btn[data-filter="casa"]').classList.add('active');
            
            // El filtro de métrica predeterminado es 'precio_m2', ya activo en HTML
            updateDashboard();

            // --- Event Listeners ---
            
            // Filtros de Operación (Alquiler / Venta)
            document.getElementById('operationFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#operationFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateOperationFilters();
                    updateDashboard();
                }
            });

            // Filtros de Tipo de Propiedad (Apartamento, Casa, Local, Oficina)
            document.getElementById('propertyFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('property-filter-hidden')) {
                    document.querySelectorAll('#propertyFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });

            // Filtros de Tipo de Alquiler (Residencial, Vacacional, Comercial)
            document.getElementById('alquilerTypeFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#alquilerTypeFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updatePropertyFilterVisibility(e.target.dataset.filter); // Asegura que solo se muestren las propiedades relevantes
                    updateDashboard();
                }
            });

            // Filtros de Métrica (Precio, Precio/m², Tamaño)
            document.getElementById('metricFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#metricFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });
        };
    </script>
</body>
</html>
