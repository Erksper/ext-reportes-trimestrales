<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mercado Inmobiliario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Paleta de Colores y Tipografía: Century Neutral Warm */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #F8F5F2; /* Fondo general */
            color: #3D405B; /* Títulos y texto principal */
        }
        .container {
            max-width: 1200px;
        }
        .text-primary {
            color: #3D405B;
        }
        .text-alquiler {
            color: #ACA68B;
        }
        .text-venta {
            color: #3D405B;
        }
        /* Colores para Gráficos de Evolución (Gráfico 3 y 4) */
        .bg-2023 {
            background-color: #B3B3B3; /* Gris Secundario */
        }
        .bg-2024 {
            background-color: #A38600; /* Dorado Opaco */
        }
        .bg-2025 {
            background-color: #ADAD86; /* Verde Seco/Activo */
        }
        .chart-container {
            position: relative;
            height: 320px;
            max-height: 320px;
            width: 100%;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
                max-height: 400px;
            }
        }
        /* Estilos de Botones de Filtro */
        .filter-btn {
            padding: 8px 16px;
            border-radius: 9999px;
            border: 1px solid #B3B3B3;
            color: #3D405B;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: white;
            white-space: nowrap; /* Evita que el texto del botón se rompa */
        }
        .filter-btn.active {
            background-color: #ADAD86; /* Color para 2025 / Estado Activo */
            color: white;
            border-color: #ADAD86;
        }
        .filter-btn:hover:not(.active) {
            background-color: #F8F5F2;
        }
        /* Estilos de Tarjetas */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Sección del Encabezado -->
    <header class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-2 text-primary" contenteditable="true">Análisis del Mercado Inmobiliario Nacional</h1>
        <h2 class="text-xl md:text-2xl font-semibold text-gray-600">Primer Semestre 2023-2025</h2>
    </header>

    <!-- Sección de Resumen del Mercado -->
    <section class="mb-12">
        <div class="container mx-auto">
            <h3 class="text-2xl md:text-3xl font-bold text-center mb-6 text-primary">Territorio Nacional</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div class="card p-4">
                    <!-- Gráfico 1: Evolución del Volumen de Operaciones -->
                    <h4 class="text-xl font-bold text-center mb-4">Evolución del Volumen de Operaciones (Lados)</h4>
                    <div class="chart-container">
                        <canvas id="ladosChart"></canvas>
                    </div>
                    <!-- Texto de Análisis para Gráfico 1 -->
                    <p id="ladosAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
                </div>

                <div class="card p-4">
                    <!-- Gráfico 2: Mix de Operaciones -->
                    <h4 class="text-xl font-bold text-center mb-4">Mix de Operaciones (Periodo Enero-Junio 2025)</h4>
                    <div class="chart-container max-w-[300px] mx-auto">
                        <canvas id="mixChart"></canvas>
                    </div>
                    <!-- Texto de Análisis para Gráfico 2 -->
                    <p id="mixAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Sección del Explorador de Mercado Detallado -->
    <section class="mb-12">
        <div class="container mx-auto">
            <h3 class="text-2xl md:text-3xl font-bold text-center mb-6 text-primary">Explorador de Mercado Detallado</h3>

            <!-- Filtros Interactivos -->
            <div class="flex flex-col gap-4 mb-6">
                <!-- 1. Filtro Tipo Operación (Alquiler/Venta) -->
                <div class="flex flex-wrap gap-2 justify-center" id="operationFilters">
                    <button class="filter-btn active" data-filter="alquiler">Alquiler</button>
                    <button class="filter-btn" data-filter="venta">Venta</button>
                </div>
                
                <!-- 2. Filtro Tipo de Alquiler (Residencial/Vacacional/Comercial - Visible solo para Alquiler) -->
                <div id="alquilerTypeFilters" class="flex flex-wrap gap-2 justify-center" style="display: flex;">
                    <button class="filter-btn active" data-filter="residencial">Residencial</button>
                    <button class="filter-btn" data-filter="vacacional">Vacacional</button>
                    <button class="filter-btn" data-filter="comercial">Comercial</button>
                </div>

                <!-- 3. Filtro Tipo de Propiedad (Apartamento/Casa/Local/Oficina - Dinámico) -->
                <div class="flex flex-wrap gap-2 justify-center" id="propertyFilters">
                    <button class="filter-btn active" data-filter="apartamento">Apartamento</button>
                    <button class="filter-btn" data-filter="casa">Casa</button>
                    <button class="filter-btn" data-filter="local" style="display: none;">Local</button>
                    <button class="filter-btn" data-filter="oficina" style="display: none;">Oficina</button>
                </div>
            </div>

            <!-- Tarjetas de Métricas Clave -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div id="cardPrecio" class="card p-4 text-center">
                    <h5 class="text-lg font-semibold">Precio Promedio (USD)</h5>
                    <p id="precioValue" class="text-3xl font-bold mt-2 text-primary"></p>
                    <p id="precioChange" class="text-sm mt-1 font-semibold"></p>
                </div>
                <div id="cardPrecioM2" class="card p-4 text-center">
                    <h5 class="text-lg font-semibold">Precio Promedio / m² (USD)</h5>
                    <p id="precioM2Value" class="text-3xl font-bold mt-2 text-primary"></p>
                    <p id="precioM2Change" class="text-sm mt-1 font-semibold"></p>
                </div>
                <div id="cardTamano" class="card p-4 text-center">
                    <h5 class="text-lg font-semibold">Promedio (m²)</h5>
                    <p id="tamanoValue" class="text-3xl font-bold mt-2 text-primary"></p>
                    <p id="tamanoChange" class="text-sm mt-1 font-semibold"></p>
                </div>
            </div>

            <!-- Gráfico 3: Evolución de Métricas Clave -->
            <div class="card p-4 mb-8">
                <h4 class="text-xl font-bold text-center mb-4">Evolución de Métricas Clave (Enero-Junio 2023-2025)</h4>
                <div class="flex flex-wrap gap-2 justify-center mb-4" id="metricFilters">
                    <button class="filter-btn" data-metric="precio">Precio Promedio</button>
                    <button class="filter-btn active" data-metric="precio_m2">Precio Promedio / m²</button>
                    <button class="filter-btn" data-metric="tamano">Promedio m²</button>
                </div>
                <div class="chart-container">
                    <canvas id="metricChart"></canvas>
                </div>
                <!-- Texto de Análisis para Gráfico 3 -->
                <p id="metricAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
            </div>

            <!-- Gráfico 4: Distribución de Operaciones por Rango de Precio -->
            <div class="card p-4">
                <h4 class="text-xl font-bold text-center mb-4">Distribución de Operaciones por Rango de Precio (Lados)</h4>
                <div class="chart-container">
                    <canvas id="rangesChart"></canvas>
                </div>
                <!-- Texto de Análisis para Gráfico 4 -->
                <p id="rangesAnalysis" class="mt-4 text-center text-sm md:text-base"></p>
            </div>
        </div>
    </section>

    <script>
        // Objeto de datos incrustado (Adaptado a partir del PDF, Enero-Marzo Qtr 1)
        const data = {
            general: {
                lados: {
                    // Datos de Lados Totales Nacionales (página 2 del PDF)
                    alquiler: [1255, 1391, 1146], 
                    venta: [1335, 1507, 1365] 
                }
            },
            alquiler: {
                // Métricas y Rangos para Alquiler
                residencial_apartamento: { 
                    metrics: {
                        precio: [381.88, 416.64, 435.84],
                        precio_m2: [4.51, 4.90, 4.93],
                        tamano: [84.61, 85.11, 88.49]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k', '$2.5k-$5k'],
                        values: [
                            [43, 206, 336, 106, 24, 2], // 2023 (p13)
                            [16, 189, 413, 103, 25, 2], // 2024
                            [21, 128, 348, 97, 16, 2]  // 2025
                        ]
                    }
                },
                residencial_casa: {
                    metrics: {
                        precio: [360.61, 378.67, 406.36],
                        precio_m2: [1.95, 1.70, 2.08],
                        tamano: [185.28, 222.72, 195.71]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k', '$2.5k-$5k'],
                        values: [
                            [21, 36, 29, 13, 3, 0], // 2023 (p14)
                            [12, 58, 50, 18, 4, 1], // 2024
                            [4, 43, 57, 13, 7, 1]  // 2025
                        ]
                    }
                },
                vacacional_apartamento: {
                    metrics: {
                        precio: [123.59, 81.45, 103.76],
                        precio_m2: [1.32, 0.95, 1.38],
                        tamano: [93.39, 85.52, 75.38]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k'],
                        values: [
                            [41, 13, 3, 1], // 2023 (p15)
                            [40, 12, 0, 0], // 2024
                            [30, 2, 4, 0]  // 2025
                        ]
                    }
                },
                vacacional_casa: {
                    metrics: {
                        precio: [325.00, 910.00, 155.00],
                        precio_m2: [0.81, 1.57, 1.36],
                        tamano: [401.25, 578.33, 114.00]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k'],
                        values: [
                            [0, 1, 5, 0, 0], // 2023 (p16 - Reajustado por datos dispersos)
                            [0, 0, 1, 1, 2], // 2024
                            [0, 2, 0, 0, 0]  // 2025
                        ]
                    }
                },
                comercial_local: {
                    metrics: {
                        precio: [447.09, 501.24, 494.43],
                        precio_m2: [5.23, 4.32, 6.96],
                        tamano: [85.49, 116.00, 71.08]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k', '$2.5k-$5k', '$5k-$10k'],
                        values: [
                            [26, 68, 62, 34, 11, 0, 0], // 2023 (p17)
                            [27, 89, 68, 32, 12, 0, 2], // 2024
                            [15, 59, 74, 32, 12, 3, 0]  // 2025
                        ]
                    }
                },
                comercial_oficina: {
                    metrics: {
                        precio: [528.95, 525.58, 526.51],
                        precio_m2: [6.34, 7.93, 4.88],
                        tamano: [83.41, 66.24, 108.00]
                    },
                    ranges: {
                        labels: ['< $100', '$100-$250', '$250-$500', '$500-$1k', '$1k-$2.5k'],
                        values: [
                            [4, 20, 22, 15, 8], // 2023 (p18)
                            [2, 17, 24, 20, 5], // 2024
                            [6, 6, 37, 24, 4]  // 2025
                        ]
                    }
                }
            },
            venta: {
                // Métricas y Rangos para Venta (implícitamente Residencial/Comercial)
                apartamento: { 
                    metrics: {
                        precio: [32883.8, 33365.5, 39440.90],
                        precio_m2: [352.21, 381.35, 443.67],
                        tamano: [93.36, 87.49, 88.90]
                    },
                    ranges: {
                        labels: ['$2.5k-$5k', '$5k-$10k', '$10k-$25k', '$25k-$50k', '$50k-$100k', '$100k-$250k', '$250k-$500k', '> $500k'],
                        values: [
                            [6, 109, 337, 262, 108, 20, 2, 0], // 2023 (p19)
                            [4, 43, 419, 276, 104, 37, 0, 0], // 2024
                            [2, 29, 303, 229, 130, 25, 0, 2]  // 2025
                        ]
                    }
                },
                casa: {
                    metrics: {
                        precio: [34726.3, 31638.5, 38925.62],
                        precio_m2: [133.00, 147.49, 172.30],
                        tamano: [261.11, 214.51, 225.92]
                    },
                    ranges: {
                        labels: ['$2.5k-$5k', '$5k-$10k', '$10k-$25k', '$25k-$50k', '$50k-$100k', '$100k-$250k', '$250k-$500k', '> $500k'],
                        values: [
                            [9, 51, 93, 47, 32, 9, 0, 0], // 2023 (p20)
                            [11, 78, 147, 76, 24, 13, 2, 1], // 2024
                            [5, 30, 152, 85, 61, 19, 7, 0]  // 2025
                        ]
                    }
                },
                local: {
                    metrics: {
                        precio: [38892.8, 25933.9, 35403.23],
                        precio_m2: [439.63, 285.60, 210.80],
                        tamano: [88.47, 90.80, 167.95]
                    },
                    ranges: {
                        labels: ['$2.5k-$5k', '$5k-$10k', '$10k-$25k', '$25k-$50k', '$50k-$100k', '$100k-$250k', '$250k-$500k'],
                        values: [
                            [4, 11, 17, 14, 8, 3, 0], // 2023 (p21)
                            [4, 11, 25, 16, 3, 1, 0], // 2024
                            [7, 5, 28, 13, 7, 0, 1]  // 2025
                        ]
                    }
                },
                oficina: {
                    metrics: {
                        precio: [65303.1, 71101.4, 80837.33],
                        precio_m2: [1153.77, 997.59, 807.00],
                        tamano: [56.60, 71.27, 100.17]
                    },
                    ranges: {
                        labels: ['$5k-$10k', '$10k-$25k', '$25k-$50k', '$50k-$100k', '$100k-$250k', '$250k-$500k'],
                        values: [
                            [1, 4, 6, 16, 4, 0], // 2023 (p22)
                            [0, 3, 3, 9, 4, 0], // 2024
                            [0, 3, 5, 8, 4, 2]  // 2025
                        ]
                    }
                }
            }
        };

        const chartColors = {
            alquiler: '#ACA68B',
            venta: '#3D405B',
            '2023': '#B3B3B3',
            '2024': '#A38600',
            '2025': '#ADAD86',
            up: '#10B981', // green
            down: '#EF4444' // red
        };

        const labelsYears = ['Enero-Junio 2023', 'Enero-Junio 2024', 'Enero-Junio 2025'];
        
        let ladosChart, mixChart, metricChart, rangesChart;

        // Función de utilidad para formatear números
        const formatNumber = (num, type = 'precio') => {
            if (num === null || isNaN(num) || num === undefined) return 'N/A';
            if (type === 'precio') {
                return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'USD', maximumFractionDigits: (num >= 1000) ? 0 : 2 }).format(num);
            }
            if (type === 'precio_m2') {
                return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(num) + ' / m²';
            }
            if (type === 'tamano') {
                return new Intl.NumberFormat('es-VE', { maximumFractionDigits: 2 }).format(num) + ' m²';
            }
            return new Intl.NumberFormat('es-VE', { maximumFractionDigits: 0 }).format(num);
        };

        // Función de utilidad para calcular el cambio porcentual (Maneja división por cero/no numérico)
        const calculatePercentageChange = (current, previous, label) => {
            // Condición para omitir el porcentaje: previous es cero, nulo, NaN o si current no es numérico.
            if (previous === 0 || previous === null || previous === undefined || isNaN(previous) || isNaN(current)) {
                return { text: ``, value: formatNumber(current, label) };
            }
            
            const change = ((current - previous) / previous) * 100;
            const sign = change >= 0 ? '▲' : '▼';
            const color = change >= 0 ? chartColors.up : chartColors.down;
            const percentage = new Intl.NumberFormat('es-VE', { maximumFractionDigits: 0 }).format(Math.abs(change));
            
            return {
                text: `<span style="color:${color};">${sign} ${percentage}% vs '24</span>`,
                value: (label === 'lados' || label === 'total') ? formatNumber(current, 'lados') : formatNumber(current, label)
            };
        };

        // --- FUNCIONES DE CREACIÓN DE GRÁFICOS ---
        const createCharts = () => {
            const ladosCtx = document.getElementById('ladosChart').getContext('2d');
            ladosChart = new Chart(ladosCtx, {
                type: 'bar',
                data: {
                    labels: labelsYears,
                    datasets: [{
                        label: 'Alquiler',
                        data: data.general.lados.alquiler,
                        backgroundColor: chartColors.alquiler,
                        hoverBackgroundColor: chartColors.alquiler
                    }, {
                        label: 'Venta',
                        data: data.general.lados.venta,
                        backgroundColor: chartColors.venta,
                        hoverBackgroundColor: chartColors.venta
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, title: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Periodo' } },
                        y: { title: { display: true, text: 'Nº de Operaciones' }, beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });

            const mixCtx = document.getElementById('mixChart').getContext('2d');
            const alquiler25 = data.general.lados.alquiler[2];
            const venta25 = data.general.lados.venta[2];
            mixChart = new Chart(mixCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Alquiler', 'Venta'],
                    datasets: [{
                        data: [alquiler25, venta25],
                        backgroundColor: [chartColors.alquiler, chartColors.venta],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, title: { display: false } }
                }
            });

            const metricCtx = document.getElementById('metricChart').getContext('2d');
            metricChart = new Chart(metricCtx, {
                type: 'bar',
                data: {
                    labels: labelsYears,
                    datasets: [{
                        label: 'Métrica',
                        data: [],
                        backgroundColor: [chartColors['2023'], chartColors['2024'], chartColors['2025']],
                        hoverBackgroundColor: [chartColors['2023'], chartColors['2024'], chartColors['2025']]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Precio (USD)' } } }
                }
            });

            const rangesCtx = document.getElementById('rangesChart').getContext('2d');
            rangesChart = new Chart(rangesCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{ label: '2023', data: [], backgroundColor: chartColors['2023'] },
                               { label: '2024', data: [], backgroundColor: chartColors['2024'] },
                               { label: '2025', data: [], backgroundColor: chartColors['2025'] }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Nº de Lados' } } }
                }
            });
        };

        const updateAnalysisText = (analysisId, text) => {
            const element = document.getElementById(analysisId);
            if (element) {
                element.innerHTML = text;
            }
        };

        // --- ANÁLISIS DEL RESUMEN DEL MERCADO ---

        const updateLadosAnalysis = () => {
            const a25 = data.general.lados.alquiler[2];
            const a24 = data.general.lados.alquiler[1];
            const v25 = data.general.lados.venta[2];
            const v24 = data.general.lados.venta[1];
            const total25 = a25 + v25;
            const total24 = a24 + v24;

            const totalChange = calculatePercentageChange(total25, total24, 'total');
            const alquilerChange = calculatePercentageChange(a25, a24, 'lados');
            const ventaChange = calculatePercentageChange(v25, v24, 'lados');
            
            const analysisText = `En el Periodo Enero-Junio 2025, el volumen total de operaciones fue de ${formatNumber(total25, 'lados')}, un cambio de ${totalChange.text} respecto a 2024. El volumen de alquileres fue de ${formatNumber(a25, 'lados')} (${alquilerChange.text}), lo que indica una **contracción fuerte** post-pico. El volumen de ventas fue de ${formatNumber(v25, 'lados')} (${ventaChange.text}).`;
            updateAnalysisText('ladosAnalysis', analysisText);
        };

        const updateMixAnalysis = () => {
            const a25 = data.general.lados.alquiler[2];
            const v25 = data.general.lados.venta[2];
            const total25 = a25 + v25;

            if (total25 === 0) return;

            const percAlquiler = (a25 / total25) * 100;
            const percVenta = (v25 / total25) * 100;

            const analysisText = `Durante el Periodo Enero-Junio 2025, el mix de operaciones se compuso de un **${percAlquiler.toFixed(0)}% de alquileres** y un **${percVenta.toFixed(0)}% de ventas**. El mercado sigue siendo activo en ambos frentes, con una ligera dominancia del sector de Venta en términos de volumen de lados.`;
            updateAnalysisText('mixAnalysis', analysisText);
        };

        // --- FUNCIONES DE FILTROS Y ESTADOS ---

        const getActiveFilters = () => {
            const operation = document.querySelector('#operationFilters .active').dataset.filter;
            const property = document.querySelector('#propertyFilters .active').dataset.filter;
            let type = null;

            if (operation === 'alquiler') {
                type = document.querySelector('#alquilerTypeFilters .active').dataset.filter;
            }
            return { operation, type, property };
        };

        const getPropertyKey = ({ operation, type, property }) => {
            if (operation === 'alquiler') {
                if (type === 'residencial' && (property === 'apartamento' || property === 'casa')) {
                    return `residencial_${property}`;
                } else if (type === 'vacacional' && (property === 'apartamento' || property === 'casa')) {
                    return `vacacional_${property}`;
                } else if (type === 'comercial' && (property === 'local' || property === 'oficina')) {
                    return `comercial_${property}`;
                }
            } else if (operation === 'venta') {
                return property; // Venta data uses property as key
            }
            return null;
        };

        const updatePropertyFilterVisibility = (operation, type) => {
            const propertyFiltersContainer = document.getElementById('propertyFilters');
            const allPropertyBtns = propertyFiltersContainer.querySelectorAll('.filter-btn');
            
            allPropertyBtns.forEach(btn => btn.style.display = 'none');
            
            const visibleFilters = [];
            if (operation === 'alquiler') {
                if (type === 'residencial' || type === 'vacacional') {
                    visibleFilters.push('apartamento', 'casa');
                } else if (type === 'comercial') {
                    visibleFilters.push('local', 'oficina');
                }
            } else { // Venta
                visibleFilters.push('apartamento', 'casa', 'local', 'oficina');
            }

            // Mostrar los botones relevantes
            allPropertyBtns.forEach(btn => {
                if (visibleFilters.includes(btn.dataset.filter)) {
                    btn.style.display = 'inline-block';
                }
            });

            // Activar el primer botón visible y desactivar los demás
            let activeFound = false;
            let newActive = null;
            allPropertyBtns.forEach(btn => {
                if (btn.classList.contains('active') && btn.style.display !== 'none') {
                    activeFound = true;
                    newActive = btn;
                }
            });

            if (!activeFound) {
                // Si el filtro activo desapareció, activamos el primer visible
                allPropertyBtns.forEach(btn => btn.classList.remove('active'));
                newActive = propertyFiltersContainer.querySelector('.filter-btn[style*="inline-block"]');
                if (newActive) newActive.classList.add('active');
            }
        };

        const updateFiltersUI = () => {
            const operation = document.querySelector('#operationFilters .active').dataset.filter;
            const alquilerTypeFilters = document.getElementById('alquilerTypeFilters');
            
            // 1. Visibilidad del filtro de Tipo de Alquiler
            alquilerTypeFilters.style.display = operation === 'alquiler' ? 'flex' : 'none';

            // 2. Visibilidad y estado de los botones de Propiedad
            const activeType = operation === 'alquiler' 
                ? document.querySelector('#alquilerTypeFilters .active')?.dataset.filter || 'residencial' 
                : null;
            
            updatePropertyFilterVisibility(operation, activeType);
        };

        // --- FUNCIÓN PRINCIPAL DE ACTUALIZACIÓN ---

        const updateDashboard = () => {
            const filters = getActiveFilters();
            const propertyKey = getPropertyKey(filters);
            const dataSet = filters.operation === 'alquiler' ? data.alquiler : data.venta;
            const propertyData = dataSet[propertyKey];
            
            updateFiltersUI();

            if (!propertyData) {
                // Reset/Clear if no data
                const noDataText = `No hay datos para ${filters.property} en ${filters.operation} (${filters.type || ''}).`;
                document.getElementById('precioValue').textContent = 'N/A';
                document.getElementById('precioChange').textContent = '';
                document.getElementById('precioM2Value').textContent = 'N/A';
                document.getElementById('precioM2Change').textContent = '';
                document.getElementById('tamanoValue').textContent = 'N/A';
                document.getElementById('tamanoChange').textContent = '';
                metricChart.data.datasets[0].data = [0, 0, 0];
                rangesChart.data.datasets.forEach(d => d.data = []);
                rangesChart.update();
                metricChart.update();
                updateAnalysisText('metricAnalysis', noDataText);
                updateAnalysisText('rangesAnalysis', noDataText);
                return;
            }

            const metrics = propertyData.metrics;
            const metric = document.querySelector('#metricFilters .active').dataset.metric;

            // 1. Actualizar Tarjetas de Métricas Clave
            const precioChange = calculatePercentageChange(metrics.precio[2], metrics.precio[1], 'precio');
            const precioM2Change = calculatePercentageChange(metrics.precio_m2[2], metrics.precio_m2[1], 'precio_m2');
            const tamanoChange = calculatePercentageChange(metrics.tamano[2], metrics.tamano[1], 'tamano');

            document.getElementById('precioValue').textContent = precioChange.value;
            document.getElementById('precioChange').innerHTML = precioChange.text;
            document.getElementById('precioM2Value').textContent = precioM2Change.value;
            document.getElementById('precioM2Change').innerHTML = precioM2Change.text;
            document.getElementById('tamanoValue').textContent = tamanoChange.value;
            document.getElementById('tamanoChange').innerHTML = tamanoChange.text;

            // 2. Actualizar Gráfico 3: Evolución de Métricas
            metricChart.data.datasets[0].data = metrics[metric];
            metricChart.options.scales.y.title.text = metric === 'tamano' ? 'Metros Cuadrados (m²)' : 'Precio (USD)';
            metricChart.update();

            // 3. Actualizar Gráfico 4: Distribución por Rangos
            rangesChart.data.labels = propertyData.ranges.labels;
            rangesChart.data.datasets[0].data = propertyData.ranges.values[0];
            rangesChart.data.datasets[1].data = propertyData.ranges.values[1];
            rangesChart.data.datasets[2].data = propertyData.ranges.values[2];
            rangesChart.update();

            // 4. Actualizar Textos de Análisis
            const propertyName = filters.property.charAt(0).toUpperCase() + filters.property.slice(1);
            const opName = filters.operation.charAt(0).toUpperCase() + filters.operation.slice(1);
            const currentMetricLabel = document.querySelector('#metricFilters .active').textContent;
            
            // Análisis de Métrica
            let metricTrend = '';
            if (metrics[metric][2] > metrics[metric][1]) {
                metricTrend = 'experimentó un **crecimiento**';
            } else if (metrics[metric][2] < metrics[metric][1]) {
                metricTrend = 'presentó una **corrección a la baja**';
            } else {
                metricTrend = 'se mantuvo **estable**';
            }
            const metricAnalysisText = `Para ${propertyName} en ${opName}, el ${currentMetricLabel} en 2025 (${formatNumber(metrics[metric][2], metric)}) ${metricTrend} respecto a 2024.`;
            updateAnalysisText('metricAnalysis', metricAnalysisText);

            // Análisis de Rangos
            const currentRanges = propertyData.ranges.values[2];
            const maxLados = Math.max(...currentRanges);
            const maxIndex = currentRanges.indexOf(maxLados);
            const activeRange = propertyData.ranges.labels[maxIndex];

            const analysisRangesText = `En 2025, el rango de precio más activo para ${propertyName} en ${opName} fue **${activeRange}**, concentrando ${formatNumber(maxLados, 'lados')} lados. Este rango continúa dominando la actividad.`;
            updateAnalysisText('rangesAnalysis', analysisRangesText);
        };

        // --- INICIALIZACIÓN Y LISTENERS ---

        window.onload = () => {
            createCharts();
            updateLadosAnalysis();
            updateMixAnalysis();

            // Seteo inicial de filtros (Alquiler / Residencial / Apartamento / Precio/m²)
            const opBtn = document.querySelector('#operationFilters .filter-btn[data-filter="alquiler"]');
            const typeBtn = document.querySelector('#alquilerTypeFilters .filter-btn[data-filter="residencial"]');
            const propBtn = document.querySelector('#propertyFilters .filter-btn[data-filter="apartamento"]');

            document.querySelectorAll('#operationFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#alquilerTypeFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#propertyFilters .filter-btn').forEach(btn => btn.classList.remove('active'));

            if (opBtn) opBtn.classList.add('active');
            if (typeBtn) typeBtn.classList.add('active');
            if (propBtn) propBtn.classList.add('active');
            
            updateDashboard();

            // Listener para Tipo de Operación (Alquiler/Venta)
            document.getElementById('operationFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#operationFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });
            
            // Listener para Tipo de Alquiler (Residencial/Vacacional/Comercial)
            document.getElementById('alquilerTypeFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#alquilerTypeFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });

            // Listener para Tipo de Propiedad (Apartamento/Casa/Local/Oficina)
            document.getElementById('propertyFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#propertyFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });

            // Listener para Filtros de Métrica (Precio/m², Precio, m²)
            document.getElementById('metricFilters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#metricFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });
        };
    </script>
</body>
</html>
